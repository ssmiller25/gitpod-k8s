# https://taskfile.dev

version: '3'

vars:
  version: 20211230-1
  release_date: 
    sh: date +%Y-%m-%d
  upstream_image: gitpod/workspace-full@sha256:46859378f3067e50e8d9509e270f67a0447bb28f5d2a2f0c723dc916411a46c8
  image_name: gitpod-k8s
  build_repo: quay.io/ssmiller25
  build_image: '{{.build_repo}}/{{.image_name}}'
  git_hash:
    sh: git rev-parse --short -q HEAD
  run_flags: 

tasks:
  default:
    cmds:
      - echo "{{.version}}"
    silent: true
  docker:latest-sha256:
    cmds:
      - docker pull gitpod/workspace-full:latest      
      - docker inspect --format='{{"{{"}}index .RepoDigests 0{{"}}"}}' gitpod/workspace-full:latest
  docker:build:
    cmds:
      - |
        docker build . -t {{.build_image}}:{{.git_hash}} \
        --build-arg GIT_HASH={{.git_hash}} \
        --build-arg VERSION={{.version}} \
        --build-arg RELEASE_DATE={{.release_date}} \
        --build-arg UPSTREAM_IMAGE={{.upstream_image}}
  docker:run:
    cmds:
      - task: docker:stop
      - docker run --rm {{.run_flags}} --name {{.image_name}} {{.build_image}}:{{.git_hash}}

  docker:stop:
    cmds:
      - docker stop {{.image_name}} > /dev/null 2>&1 || true

  docker:push:
    cmds:
      - docker tag {{.build_image}}:{{.git_hash}} {{.build_image}}:{{.version}}
      - docker tag {{.build_image}}:{{.git_hash}} {{.build_image}}:latest
      - docker push {{.build_image}}:{{.git_hash}}
      - docker push {{.build_image}}:{{.version}}
      - docker push {{.build_image}}:latest
